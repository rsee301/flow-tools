# MCP Suite Maintenance Strategy

## Overview
This guide helps you maintain your MCP suite (Claude Flow + Code Index + custom MCPs) while receiving Claude Flow updates.

## 1. Version Control Strategy

### Separate Your Configurations
```bash
flow-tools/
‚îú‚îÄ‚îÄ .claude/                    # Claude Flow managed (gitignored)
‚îÇ   ‚îú‚îÄ‚îÄ settings.json           # Auto-generated by Claude Flow
‚îÇ   ‚îî‚îÄ‚îÄ agents/                 # Claude Flow agent definitions
‚îú‚îÄ‚îÄ .claude.local/              # Your custom layer (version controlled)
‚îÇ   ‚îú‚îÄ‚îÄ settings.override.json  # Your custom settings
‚îÇ   ‚îú‚îÄ‚îÄ mcp-config.json        # Your MCP suite configuration
‚îÇ   ‚îî‚îÄ‚îÄ custom-agents/          # Your custom agent definitions
‚îú‚îÄ‚îÄ CLAUDE.md                   # Project instructions (version controlled)
‚îî‚îÄ‚îÄ package.json                # Your project config
```

### Implementation
```bash
# Create local configuration directory
mkdir -p .claude.local

# Create MCP suite configuration
cat > .claude.local/mcp-config.json << 'EOF'
{
  "mcpServers": {
    "claude-flow": {
      "command": "npx",
      "args": ["claude-flow@alpha", "mcp", "start"],
      "version": "alpha",
      "autoUpdate": true
    },
    "code-index": {
      "command": "npx",
      "args": ["@modelcontextprotocol/server-code-index"],
      "version": "latest",
      "config": {
        "projectPath": ".",
        "excludePatterns": ["node_modules", ".git"]
      }
    },
    "custom-mcp": {
      "command": "node",
      "args": ["./mcp-servers/custom.js"],
      "version": "local"
    }
  }
}
EOF
```

## 2. Configuration Overlay System

### Create Settings Override
```bash
cat > .claude.local/settings.override.json << 'EOF'
{
  "enabledMcpjsonServers": ["claude-flow", "code-index", "custom-mcp"],
  "customHooks": {
    "PreToolUse": [
      {
        "matcher": "Task",
        "hooks": [{
          "type": "command",
          "command": "echo 'Custom pre-task hook for MCP coordination'"
        }]
      }
    ]
  },
  "customAgentInstructions": {
    "researcher": "Always use mcp__code-index__search_code_advanced for searching",
    "coder": "Use mcp__code-index__find_files before creating new files"
  }
}
EOF
```

### Merge Script
```javascript
// scripts/merge-configs.js
const fs = require('fs');
const path = require('path');

function mergeConfigs() {
  // Load base Claude Flow settings
  const basePath = path.join('.claude', 'settings.json');
  const base = JSON.parse(fs.readFileSync(basePath, 'utf8'));
  
  // Load your overrides
  const overridePath = path.join('.claude.local', 'settings.override.json');
  const override = JSON.parse(fs.readFileSync(overridePath, 'utf8'));
  
  // Deep merge
  const merged = deepMerge(base, override);
  
  // Write back to settings.json
  fs.writeFileSync(basePath, JSON.stringify(merged, null, 2));
  console.log('‚úÖ Configurations merged successfully');
}

function deepMerge(target, source) {
  const output = Object.assign({}, target);
  if (isObject(target) && isObject(source)) {
    Object.keys(source).forEach(key => {
      if (isObject(source[key])) {
        if (!(key in target))
          Object.assign(output, { [key]: source[key] });
        else
          output[key] = deepMerge(target[key], source[key]);
      } else {
        Object.assign(output, { [key]: source[key] });
      }
    });
  }
  return output;
}

function isObject(item) {
  return item && typeof item === 'object' && !Array.isArray(item);
}

mergeConfigs();
```

## 3. Update Testing Workflow

### Create Update Test Script
```bash
cat > scripts/test-claude-flow-update.sh << 'EOF'
#!/bin/bash

# Save current configuration
cp -r .claude .claude.backup
cp CLAUDE.md CLAUDE.md.backup

# Test new version
echo "Testing Claude Flow update..."
npx claude-flow@next version

# Run compatibility checks
npx claude-flow@next hooks validate
npx claude-flow@next swarm test

# Check MCP compatibility
echo "Testing MCP servers..."
npx claude-flow@next mcp test claude-flow
npx claude-flow@next mcp test code-index

# Restore if failed
if [ $? -ne 0 ]; then
  echo "Update failed, restoring backup..."
  rm -rf .claude
  mv .claude.backup .claude
  mv CLAUDE.md.backup CLAUDE.md
else
  echo "Update successful!"
  rm -rf .claude.backup CLAUDE.md.backup
fi
EOF

chmod +x scripts/test-claude-flow-update.sh
```

## 4. Custom MCP Integration Documentation

### Create Integration Guide
```markdown
# MCP Integration Guide

## Code-Index Integration with Claude Flow Agents

When spawning agents, include code-index tools in their instructions:

\`\`\`javascript
const AGENT_MCP_MAPPING = {
  "researcher": [
    "mcp__code-index__search_code_advanced",
    "mcp__code-index__find_files",
    "mcp__code-index__get_file_summary"
  ],
  "coder": [
    "mcp__code-index__find_files",
    "mcp__code-index__refresh_index"
  ],
  "code-analyzer": [
    "mcp__code-index__search_code_advanced",
    "mcp__code-index__get_file_summary"
  ]
};

// When spawning agents
Task("Research patterns", \`
  You are the researcher agent.
  
  USE THESE MCP TOOLS FOR EFFICIENCY:
  - mcp__code-index__search_code_advanced for pattern searching
  - mcp__code-index__find_files for file discovery
  - mcp__code-index__get_file_summary for quick analysis
  
  COORDINATION REQUIREMENTS:
  - Run npx claude-flow@alpha hooks pre-task
  - Store findings with mcp__claude-flow__memory_usage
  - Run npx claude-flow@alpha hooks post-task
  
  Task: [specific research task]
\`, "researcher");
\`\`\`
```

## 5. Automated Compatibility Checks

### GitHub Action for Update Testing
```yaml
# .github/workflows/test-claude-flow-updates.yml
name: Test Claude Flow Updates

on:
  schedule:
    - cron: '0 0 * * 0' # Weekly
  workflow_dispatch:

jobs:
  test-update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Test Claude Flow Alpha
        run: |
          npx claude-flow@alpha version
          npx claude-flow@alpha hooks validate
          
      - name: Test MCP Compatibility
        run: |
          # Test each MCP server
          npx @modelcontextprotocol/server-code-index --version
          
      - name: Run Integration Tests
        run: |
          npm run test:mcp-integration
          
      - name: Create Issue if Failed
        if: failure()
        uses: actions/create-issue@v2
        with:
          title: Claude Flow Update Compatibility Issue
          body: |
            The latest Claude Flow update may have compatibility issues.
            Check the workflow run for details.
```

## 6. Version Pinning Strategy

### Package.json Approach
```json
{
  "scripts": {
    "claude-flow": "npx claude-flow@1.0.0",
    "claude-flow-alpha": "npx claude-flow@alpha",
    "update-claude-flow": "npm run test:compatibility && npm run claude-flow-alpha"
  },
  "claudeFlowVersion": {
    "stable": "1.0.0",
    "testing": "alpha",
    "lastTested": "2024-08-04"
  }
}
```

## 7. Rollback Strategy

### Create Rollback Script
```bash
cat > scripts/rollback.sh << 'EOF'
#!/bin/bash

VERSION=${1:-"stable"}

echo "Rolling back to $VERSION..."

# Restore from git
git checkout HEAD -- .claude/
git checkout HEAD -- CLAUDE.md

# Reinstall specific version
npx claude-flow@$VERSION init

# Reapply local configurations
node scripts/merge-configs.js

echo "‚úÖ Rolled back to $VERSION"
EOF

chmod +x scripts/rollback.sh
```

## 8. Best Practices

### Do's:
- ‚úÖ Keep local customizations in `.claude.local/`
- ‚úÖ Version control your override configurations
- ‚úÖ Test updates in a branch first
- ‚úÖ Document custom MCP integrations
- ‚úÖ Use semantic versioning for your flow-tools
- ‚úÖ Create backups before updates
- ‚úÖ Monitor Claude Flow release notes

### Don'ts:
- ‚ùå Modify `.claude/` files directly (they get overwritten)
- ‚ùå Skip compatibility testing
- ‚ùå Update all MCPs simultaneously
- ‚ùå Ignore deprecation warnings

## 9. Update Checklist

Before updating Claude Flow:
- [ ] Backup current configuration
- [ ] Review release notes
- [ ] Test in development branch
- [ ] Run compatibility checks
- [ ] Update integration documentation
- [ ] Test all MCP servers
- [ ] Verify agent behaviors
- [ ] Check hook functionality
- [ ] Update team documentation

## 10. Monitoring & Alerts

### Create Health Check
```bash
cat > scripts/health-check.sh << 'EOF'
#!/bin/bash

echo "üîç MCP Suite Health Check"

# Check Claude Flow
if npx claude-flow@alpha version > /dev/null 2>&1; then
  echo "‚úÖ Claude Flow: OK"
else
  echo "‚ùå Claude Flow: FAILED"
fi

# Check Code Index
if npx @modelcontextprotocol/server-code-index --help > /dev/null 2>&1; then
  echo "‚úÖ Code Index: OK"
else
  echo "‚ùå Code Index: FAILED"
fi

# Check custom MCPs
for mcp in $(jq -r '.mcpServers | keys[]' .claude.local/mcp-config.json); do
  echo "üîç Checking $mcp..."
done

# Check agent coordination
npx claude-flow@alpha hooks validate
EOF

chmod +x scripts/health-check.sh
```

## Usage

1. **Initial Setup:**
   ```bash
   npm run setup
   node scripts/merge-configs.js
   ```

2. **Before Updates:**
   ```bash
   ./scripts/test-claude-flow-update.sh
   ```

3. **After Updates:**
   ```bash
   ./scripts/health-check.sh
   node scripts/merge-configs.js
   ```

4. **If Issues Occur:**
   ```bash
   ./scripts/rollback.sh stable
   ```